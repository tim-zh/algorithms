import org.scalatest.{FlatSpec, Matchers}

class HyperLogLogSpec extends FlatSpec with Matchers {
  "HyperLogLog" should "calculate an approximate number of collection's unique elements" in {
    val xs = Seq(-330651821, -722209082, 313622883, 641200391, -1399691884, 1696384529, -1135661078, 1716032436,
      1900377650, -1745156164, -773252329, 1062142571, 978433737, -524856714, -21689243, -301236471, 1389570273,
      102160159, -796891862, -1121238341, 313622883, 313622883, -726582845, -868285096, -1121238341, -35349108,
      1911067300, 397757780, 1013116707, -1283654849, -1000418655, -1135661078, -1057765653, -906013006, -1004691672,
      199659580, -1022072306, 2025016175, 580746112, 172949555, 1102743778, -2123788910, -486156087, -630055423,
      1050316547, -1356642586, -2031065486, -1046250308, -1791407020, -592836014, -617423647, 1316810996, 1840039787,
      -1176551311, -961728401, 674226543, 246239788, -725792414, 731476151, -1966182629, -275725133, -93820964,
      2103695376, -135616448, 1074004599, -1543845500, -394932393, -31900940, 1643457963, 1637367938, 247917041,
      -1865917740, 1013132519, -99909039, -2018304497, -1011692048, -236099833, 922222550, 600161588, -1790814969,
      -1639392941, 1657318068, -769855245, -122428685, -395449376, 926235614, 1426178045, 1728272230, -1230723019,
      381472621, 1653399387, -1144278826, 1271608880, -1307711054, -1930374153, 346286517, -728972502, -918472305,
      1350969440, 1297085669, -1644349607, 1095609346, -465650995, -1130328725, 661675382, -848190206, 535914338,
      743689570, 900292767, -1950977650, -1153461582, 83083313, 1474937982, 410011394, -739616636, 483353600,
      -1372243031, 1206805419, -1685757222, 167628391, -1785593781, 1018438814, 248622382, -1172150168, 1902351108,
      1556948165, -51726338, 312767903, -2106063858, 2002499898, 2115301515, -1736746313, 1799236256, -1918738729,
      1638158556, 1792300832, 387804822, 1304292621, 1818131465, -17979906, -1890711471, -1706057228, 1563155125,
      13515364, 1411046107, 112417700, 958364635, -213873983, -194753457, 474976962, 34979278, -991289446, 1489879159,
      -2142115235, -1599732870, -1480533639, -227173962, -1291556614, -484181521, 1455039013, 1085400104, -2146128147,
      875639328, 1520401682, -599126265, 1122483690, 1277694695, 1035414298, -79144880, -1599461925, 498427723,
      1571214701, -1526477146, 611691251, -1752822523, -958303290, 749604213, 1843575042, 1329760064, 1280369119,
      -4319399, 552417290, -1922401887, -1543579609, 121893569, 343512595, -1975627898, 1837644721, 1304882383,
      71309883, -1979346031, -1805584018, -116742526, 1219613968, 1055177575, -576855906, -30060521, 1556857377,
      -1067619404, -1302515581, -107759957, -1409159470, 549484658, 1681771864, -673314779, -1162495376, 1334388075,
      2078298240, 1068134738, 122127237, 1896704764, -915642366, 82377296, 1644516972, 140985114, 1338521909, 672548144,
      608006439, 1815560858, 332839607, -1651961129, -338382737, -1306459476, -454215261, 555266596, -298960372,
      -68804952, 1509916162, -577192617, -1003292569, 1410124301, 855982721, -2138519120, -954418340, -884260155,
      -1223494812, 656207190, -879619499, -1950243923, 1623910587, 1152270202, -1411566700, 530570069, -2090102830,
      1911600828, -1546025777, 1047382787, -1911408659, -499250739, -690448127, 1661456894, 672233012, -820283819,
      1517860734, 79841544, -1145744148)
    val uniques = 252

    val result = HyperLogLog.getApproximateSetCardinality(xs, 64)

    (math.abs(result - uniques) / uniques.asInstanceOf[Double]) should be < 0.02
  }
}
